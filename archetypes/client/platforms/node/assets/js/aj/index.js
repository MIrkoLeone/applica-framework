"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function createRuntime(e){return __runtime=AJRuntime.create(),__runtime.init(e),__runtime}function createStore(e,t){if(_.has(__stores,e))throw"Cannot create store "+e+". Only one instance of store is allowed";var r=new Store(e,t);return __stores[e]=r,logger.i("Store created:",e),r}function createAction(e,t){if(_.has(__actions,e))throw"Cannot create action "+e+". Already created";var r=__actions[e]=function(e){t(e)};return logger.i("Action created:",e),r}function dispatch(e){logger.i("Dispatching action",e),_.each(__stores,function(t){try{t.dispatch(e)}catch(r){r&&r.stack&&logger.i(r.stack),logger.e(r)}})}function _run(e,t){logger.i("Running action",e),_.has(__actions,e)?__actions[e](t):logger.w("Cannot find action: "+e)}function exec(e,t,r){return __runtime.exec(e,t,r)}function createBuffer(e){return __runtime.createBuffer(e)}function readBuffer(e){return __runtime.readBuffer(e)}function destroyBuffer(e){return __runtime.destroyBuffer(e)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();exports.createBuffer=createBuffer,exports.readBuffer=readBuffer,exports.destroyBuffer=destroyBuffer;var _=require("../libs/underscore"),Observable=require("../framework/events").Observable,__runtime=null,__stores={},__actions={},AJRuntime=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"exec",value:function(){throw"Not implemented"}},{key:"createBuffer",value:function(){throw"Not implemented"}},{key:"loadBuffer",value:function(){throw"Not implemented"}},{key:"destroyBuffer",value:function(){throw"Not implemented"}},{key:"__trigger",value:function(){throw"Not implemented"}}],[{key:"instance",value:function(){if(!__runtime)throw"Runtime not initialized";return __runtime}}]),e}();"node"==platform.engine?!function(){var e=(require("vm"),require("fs"),function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.semaphores=[],logger.i("New websocket server runtime created"),e}return _inherits(t,e),_createClass(t,[{key:"init",value:function(e){var t=this;if(this.socket=e.socket,!this.socket)throw"Socket is required";this.socket.on("run",function(e,t,r){async(function(){try{var n=JSON.parse(t);_run(e,n),r()}catch(i){i&&i.stack&&logger.i(i.stack),logger.e(i)}})}),this.socket.on("freeSemaphore",function(e,r){try{t.freeSemaphore(e,r)}catch(n){n&&n.stack&&logger.i(n.stack),logger.e(n)}}),this.socket.on("error",function(e){e&&e.stack&&logger.i(e.stack),logger.e(e)})}},{key:"exec",value:function(e,t,r){var n=this;return logger.i("Executing plugin ",e+"."+t),new Promise(function(i,o){try{n.socket.emit("exec",e,t,r,function(e){i(e)})}catch(u){o(u)}})}},{key:"__trigger",value:function(e,t){var r=this;return logger.i("Triggering ",e),new Promise(function(n){r.socket.emit("trigger",e,t,function(){n()})})}},{key:"freeSemaphore",value:function(e,t){for(var r=-1,n=!1,i=0;i<this.semaphores.length;i++){r++;var o=this.semaphores[i];if(o.id==e){n=!0,o.free(t);break}}n&&(this.semaphores.splice(r,1),logger.i("Semaphore destroyed:",o.name))}},{key:"createBuffer",value:function(e){var t=this;return new Promise(function(r,n){t.socket.emit("createBuffer",e,function(e,t){e?n():r(t)})})}},{key:"readBuffer",value:function(e){var t=this;return new Promise(function(r,n){t.socket.emit("readBuffer",e,function(e,t){e?n():r(t)})})}},{key:"destroyBuffer",value:function(e){var t=this;return new Promise(function(r,n){t.socket.emit("readBuffer",e,function(e){e?n():r()})})}}]),t}(AJRuntime));AJRuntime.create=function(){return new e}}():!function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return logger.i("New native server runtime created"),e}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){}},{key:"run",value:function(e,t){_run(e,t)}},{key:"__trigger",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){if(void 0==__trigger)throw"__trigger function not defined";return logger.i("Triggering ",e),new Promise(function(r,n){async(function(){try{__trigger(e,t),r()}catch(i){n(i)}})})})},{key:"exec",value:function(e,t,r){if(void 0==__exec)throw"__exec function not defined";return logger.i("Executing plugin",e+"."+t),new Promise(function(n,i){async(function(){try{var o=__exec(e,t,r);logger.i("Plugin called with res:",o),n(o)}catch(u){i(u)}})})}},{key:"createBuffer",value:function(e){return new Promise(function(t,r){__buffersManager.create(e,function(e,n){e?r(n):t(n)})})}},{key:"readBuffer",value:function(e){return new Promise(function(t,r){__buffersManager.read(e,function(e,n){e?r(n):t(n)})})}},{key:"destroyBuffer",value:function(e){return new Promise(function(t,r){__buffersManager.destroy(e,function(e,n){e?r(n):t(n)})})}}]),t}(AJRuntime);AJRuntime.create=function(){return new e}}();var Store=function(e){function t(e,r){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.type=e,n.reducer=r,n.subscriptions=[],n}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){}},{key:"subscribe",value:function(e,t){this.subscriptions.push({owner:e,subscription:t})}},{key:"unsubscribe",value:function(e){this.subscriptions=_.filter(this.subscriptions,function(t){return t.owner!=e})}},{key:"trigger",value:function(e){var t=e||this.state;return _.each(this.subscriptions,function(e){e.subscription(t)}),__runtime.__trigger(this.type,t)}},{key:"dispatch",value:function(e){if(_.isFunction(this.reducer)){var t=this.reducer(this.state,e);t&&(this.state=t,this.trigger())}else logger.w("Cannot dispatch action:",this.type+"."+e)}}]),t}(Observable),Semaphore=function(){function e(t){_classCallCheck(this,e),this.complete=!1,this.listeners=[],this.id=e.counter++,t&&this.runAction(t)}return _createClass(e,[{key:"runAction",value:function(e){var t=this;async(function(){e(),t.free()})}},{key:"then",value:function(e){return this.listeners.push(e),this.complete&&e(),this}},{key:"free",value:function(e){return this.listeners.forEach(function(t){t(e)}),this.complete=!0,this}}]),e}();Semaphore.counter=1;var createRuntime=exports.createRuntime=createRuntime,createStore=exports.createStore=createStore,createAction=exports.createAction=createAction,dispatch=exports.dispatch=dispatch,exec=exports.exec=exec,_run=_run;exports.run=_run;